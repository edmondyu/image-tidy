<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HTML / XHTML Text Extractor</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #output {
      white-space: pre-wrap;
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 10px;
    }
    #warningBox {
      display: none;
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #d9534f;
      background: #fff3f3;
      color: #b52b27;
      font-family: monospace;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<h2>HTML / XHTML Text Extractor</h2>

<input type="file" id="fileInput" accept=".html,.xhtml,.htm" />

<div id="warningBox"></div>

<div id="output"></div>

<script>
  const fileInput = document.getElementById("fileInput");
  const output = document.getElementById("output");

  fileInput.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const text = await file.text();
    const doc = parseDocument(text, file.name);
    extractText(doc);
  });

  function parseDocument(text, fileName = "") {
    const warningBox = document.getElementById("warningBox");

    // Detect XHTML-style self-closing script tags
    const scriptSelfClosingRegex = /<script\b[^>]*\/>/i;
    const hasSelfClosingScript = scriptSelfClosingRegex.test(text);

    if (hasSelfClosingScript) {
      warningBox.style.display = "block";
      warningBox.textContent =
        "⚠️ Warning detected:\n\n" +
        "This document contains self-closing <script .../> tags.\n" +
        "These are valid in XHTML/XML but will break HTML parsing.\n\n" +
        "Parser switched to application/xhtml+xml mode.";
    } else {
      warningBox.style.display = "none";
      warningBox.textContent = "";
    }

    // Decide whether to parse as XHTML
    const isXhtml =
      /\.xhtml$/i.test(fileName) ||
      text.trimStart().startsWith("<?xml") ||
      text.includes('xmlns="http://www.w3.org/1999/xhtml"');

    const mimeType = isXhtml
      ? "application/xhtml+xml"
      : "text/html";

    const parser = new DOMParser();
    const doc = parser.parseFromString(text, mimeType);

    // Catch XHTML parse errors
    if (mimeType === "application/xhtml+xml") {
      const parserError = doc.querySelector("parsererror");
      if (parserError) {
        warningBox.style.display = "block";
        warningBox.textContent +=
          "\n\n❌ XHTML parser error:\n" +
          parserError.textContent.trim();
      }
    }

    return doc;
  }

  function extractText(doc) {
    const parts = [];

    doc.querySelectorAll("h1,h2,h3,h4,h5,h6,p").forEach(el => {
      const text = el.textContent.trim();
      if (text) parts.push(text);
    });

    doc.querySelectorAll("img").forEach(img => {
      const alt = img.getAttribute("alt");
      if (alt) parts.push("[Image: " + alt + "]");
    });

    output.textContent = parts.join("\n\n");
  }
</script>

</body>
</html>
