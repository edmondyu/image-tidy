<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Toolbox ‚Äì Royalty Reporting</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 1100px;
      margin: 0 auto;
      padding: 1.5rem;
      background: #131313;
      color: #f9f9f9;
    }
    header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }
    h1 {
      margin: 0;
      font-size: 1.25rem;
      color: #50e3c2;
    }
    .subtitle {
      margin: 0.35rem 0 0;
      color: #9ca3af;
      font-size: 0.95rem;
      line-height: 1.4;
    }
    a.link {
      color: #50e3c2;
      text-decoration: none;
      font-weight: 600;
    }
    a.link:hover {
      text-decoration: underline;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.25rem;
      margin-top: 1.25rem;
    }
    @media (min-width: 900px) {
      .grid {
        grid-template-columns: 1.15fr 0.85fr;
      }
    }
    .card {
      background: #1f1f1f;
      border-radius: 12px;
      padding: 1.25rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      border: 1px solid #2a2a2a;
    }
    label {
      display: block;
      margin: 0.75rem 0 0.35rem;
      color: #50e3c2;
      font-size: 0.85rem;
    }
    input[type="text"], input[type="file"] {
      width: 100%;
      box-sizing: border-box;
      padding: 0.65rem 0.75rem;
      border-radius: 10px;
      border: 1px solid #3a3a3a;
      background: #2a2a2a;
      color: #f9f9f9;
    }
    .row {
      display: flex;
      gap: 0.6rem;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 0.9rem;
    }
    button {
      appearance: none;
      border: 0;
      border-radius: 999px;
      padding: 0.6rem 1.05rem;
      font-size: 0.9rem;
      background: #50e3c2;
      color: #131313;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background: #3dd4b3;
    }
    button.secondary {
      background: #3a3a3a;
      color: #f9f9f9;
    }
    button.secondary:hover {
      background: #4a4a4a;
    }
    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0.65rem;
      border-radius: 999px;
      font-size: 0.8rem;
      background: #2a2a2a;
      color: #d1d5db;
      border: 1px solid #3a3a3a;
    }
    .pill.ok {
      background: #064e3b;
      border-color: #10b981;
      color: #6ee7b7;
    }
    .pill.bad {
      background: #7f1d1d;
      border-color: #dc2626;
      color: #fca5a5;
    }
    .small {
      margin-top: 0.65rem;
      font-size: 0.85rem;
      color: #9ca3af;
      line-height: 1.5;
    }
    .kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 0.82rem;
      background: #2a2a2a;
      padding: 0.12rem 0.4rem;
      border-radius: 8px;
      border: 1px solid #3a3a3a;
      color: #50e3c2;
      white-space: nowrap;
    }
    pre {
      margin: 0;
      padding: 0.85rem;
      background: #0a0a0a;
      border-radius: 12px;
      color: #dbeafe;
      height: 360px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
      box-shadow: inset 0 0 0 1px rgba(80,227,194,0.1);
    }
    .note {
      margin-top: 0.75rem;
      padding: 0.75rem;
      border-radius: 12px;
      background: #2a2410;
      border: 1px solid #50e3c2;
      color: #d1d5db;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    .drop-zone {
      position: relative;
      border: 2px dashed #3a3a3a;
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      transition: all 0.3s;
      background: #2a2a2a;
      margin-top: 0.5rem;
    }
    .drop-zone.drag-over {
      border-color: #50e3c2;
      background: #1a3a35;
    }
    .drop-zone p {
      margin: 0.5rem 0;
      color: #9ca3af;
    }
    .drop-zone .drop-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      color: #50e3c2;
    }
    .drop-zone input[type="file"] {
      display: none;
    }
    .drop-zone .file-input-wrapper {
      margin-top: 1rem;
    }
    .drop-zone .browse-btn {
      background: #3a3a3a;
      color: #f9f9f9;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      display: inline-block;
      font-size: 0.9rem;
    }
    .drop-zone .browse-btn:hover {
      background: #4a4a4a;
    }
    .drop-zone.has-file {
      border-color: #10b981;
      background: #064e3b;
    }
    .drop-zone.has-file .drop-icon {
      color: #10b981;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Royalty Reporting (Multi-platform)</h1>
      <p class="subtitle">
        Upload CSV/XLSX reports, generate per-publisher summary CSVs, and download everything as a ZIP.
        All processing happens locally in your browser.
      </p>
    </div>
    <div>
      <a class="link" href="index.html">‚Üê Back to Toolbox</a>
    </div>
  </header>

  <div class="grid">
    <div class="card">
      <label>Date range label (used in output filenames & report title)</label>
      <input id="dateString" type="text" value="2024-10-01_to_2025-06-30" />

      <label>Upload source reports (multiple files allowed)</label>
      <div class="drop-zone" id="reportDropZone">
        <div class="drop-icon">üìä</div>
        <p><strong>Drag and drop CSV/XLSX files here</strong></p>
        <p>or</p>
        <div class="file-input-wrapper">
          <label for="fileInput" class="browse-btn">Browse Files</label>
          <input id="fileInput" type="file" multiple accept=".csv,.xlsx" />
        </div>
      </div>

      <div class="row">
        <button id="processBtn" disabled>Process</button>
        <button id="downloadBtn" class="secondary" disabled>Download ZIP</button>
        <button id="downloadSummaryBtn" class="secondary" disabled>Download Summary XLSX</button>
        <span id="statusPill" class="pill">Idle</span>
      </div>

      <p class="small">
        Platform detection is based on the filename containing one of:
        <span class="kbd">Google</span>, <span class="kbd">kobo</span>, <span class="kbd">koboplus</span>,
        <span class="kbd">readmoo</span>, <span class="kbd">KDP</span>, <span class="kbd">hyread</span>
      </p>

      <div class="note">
        <strong>Copies rules</strong><br />
        Google: <span class="kbd">Qty</span> ¬∑ Readmoo: <span class="kbd">Èä∑ÂîÆÊï∏Èáè</span> ¬∑ Kobo: <span class="kbd">Paid Units</span> ¬∑
        KDP: <span class="kbd">Net Units Sold</span> ¬∑ HyRead: <span class="kbd">ÂÄüÈñ±‰∫∫Êï∏</span> when <span class="kbd">ÂÇôË®ª</span> contains <span class="kbd">ÂñÆÈ§®Êé°Ë≥º</span> ¬∑
        KoboPlus: not applicable
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content: space-between; margin-top: 0;">
        <span class="pill ok">Processing Status</span>
        <span class="pill">Live log</span>
      </div>
      <div style="margin-top: 0.75rem;">
        <pre id="log"></pre>
      </div>
    </div>
  </div>

  <!-- Libraries via CDN (works on Netlify static hosting) -->
  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- SheetJS for XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- JSZip for ZIP output -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <script>
    // =============================
    // Royalty Reporting Tool (browser-only)
    // =============================

    const PLATFORMS = ['google', 'kobo', 'koboplus', 'readmoo', 'kdp', 'hyread'];
    const PLATFORM_DISPLAY = { google: 'Google', kobo: 'Kobo', koboplus: 'KoboPlus', readmoo: 'Readmoo', kdp: 'KDP', hyread: 'HyRead' };
    function platformLabel(p) { return PLATFORM_DISPLAY[p] || p; }

    const fileInput = document.getElementById('fileInput');
    const reportDropZone = document.getElementById('reportDropZone');
    const processBtn = document.getElementById('processBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const downloadSummaryBtn = document.getElementById('downloadSummaryBtn');
    const logEl = document.getElementById('log');
    const statusPill = document.getElementById('statusPill');
    const dateStringEl = document.getElementById('dateString');

    let lastZipBlobUrl = null;
    let lastSummaryBlobUrl = null;

    function setStatus(text, type = 'idle') {
      statusPill.textContent = text;
      statusPill.className = 'pill' + (type === 'ok' ? ' ok' : type === 'bad' ? ' bad' : '');
    }

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[${time}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function resetDownload() {
      downloadBtn.disabled = true;
      downloadSummaryBtn.disabled = true;
      if (lastZipBlobUrl) URL.revokeObjectURL(lastZipBlobUrl);
      if (lastSummaryBlobUrl) URL.revokeObjectURL(lastSummaryBlobUrl);
      lastZipBlobUrl = null;
      lastSummaryBlobUrl = null;
    }

    // Drag and drop helper functions
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    function highlight(dropZone) {
      dropZone.classList.add('drag-over');
    }

    function unhighlight(dropZone) {
      dropZone.classList.remove('drag-over');
    }

    function setupDropZone(dropZone, onDrop) {
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
      });

      dropZone.addEventListener('dragenter', () => highlight(dropZone), false);
      dropZone.addEventListener('dragover', () => highlight(dropZone), false);
      dropZone.addEventListener('dragleave', (e) => {
        if (e.target === dropZone) {
          unhighlight(dropZone);
        }
      }, false);
      dropZone.addEventListener('drop', (e) => {
        unhighlight(dropZone);
        onDrop(e);
      }, false);
    }

    function handleFileSelection(files) {
      processBtn.disabled = files.length === 0;
      resetDownload();
      logEl.textContent = '';
      setStatus(files.length ? `${files.length} file(s) selected` : 'Idle');
      if (files.length > 0) {
        reportDropZone.classList.add('has-file');
      } else {
        reportDropZone.classList.remove('has-file');
      }
    }

    fileInput.addEventListener('change', () => {
      const files = [...(fileInput.files || [])];
      handleFileSelection(files);
    });

    setupDropZone(reportDropZone, (e) => {
      const files = Array.from(e.dataTransfer.files);
      const reportFiles = files.filter(f =>
        f.name.endsWith('.csv') ||
        f.name.endsWith('.xlsx') ||
        f.type === 'text/csv' ||
        f.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      );
      if (reportFiles.length > 0) {
        const dataTransfer = new DataTransfer();
        reportFiles.forEach(file => dataTransfer.items.add(file));
        fileInput.files = dataTransfer.files;
        handleFileSelection(reportFiles);
      }
    });

    function detectPlatform(filename) {
      const lower = filename.toLowerCase();
      const sorted = [...PLATFORMS].sort((a, b) => b.length - a.length);
      for (const p of sorted) {
        if (lower.includes(p)) return p;
      }
      return null;
    }

    function normalizeKeys(rowObj) {
      const out = {};
      for (const [k, v] of Object.entries(rowObj || {})) {
        if (k == null) continue;
        out[String(k).trim().toLowerCase()] = v;
      }
      return out;
    }

    function safeString(x, fallback) {
      const s = (x == null) ? '' : String(x).trim();
      return s === '' ? fallback : s;
    }

    function toNumber(x) {
      if (x == null) return 0;
      const s = String(x).replace(/,/g, '').trim();
      if (s === '') return 0;
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }

    function csvStringify(rows) {
      const esc = (cell) => {
        const s = (cell == null) ? '' : String(cell);
        return /[",\n\r]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
      };
      return rows.map(r => r.map(esc).join(',')).join('\r\n');
    }

    function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = () => reject(fr.error);
        fr.readAsText(file);
      });
    }

    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = () => reject(fr.error);
        fr.readAsArrayBuffer(file);
      });
    }

    async function parseCSVFile(file) {
      const text = await readFileAsText(file);
      const parsed = Papa.parse(text, {
        header: true,
        skipEmptyLines: true,
        dynamicTyping: false
      });
      if (parsed.errors && parsed.errors.length) {
        log(`‚ö†Ô∏è CSV parse warnings in ${file.name}: ${parsed.errors[0].message}`);
      }
      return parsed.data || [];
    }

    async function parseXLSXFile(file) {
      const ab = await readFileAsArrayBuffer(file);
      const wb = XLSX.read(ab, { type: 'array' });
      const sheetName = wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];
      return XLSX.utils.sheet_to_json(ws, { defval: '' }) || [];
    }

    function deriveCopies(platform, rowLower) {
      // platform is always lowercase; rowLower keys are already lowercased (Chinese keys unchanged)
      if (platform === 'google') return toNumber(rowLower['qty']);
      if (platform === 'readmoo') return toNumber(rowLower['Èä∑ÂîÆÊï∏Èáè']);
      if (platform === 'kobo') return toNumber(rowLower['paid units']);
      if (platform === 'kdp') return toNumber(rowLower['net units sold']);

      if (platform === 'hyread') {
        const noteRaw = safeString(rowLower['ÂÇôË®ª'], '');
        const noteCompact = noteRaw.replace(/\s+/g, '');
        return noteCompact.includes('ÂñÆÈ§®Êé°Ë≥º') ? toNumber(rowLower['ÂÄüÈñ±‰∫∫Êï∏']) : 0;
      }

      // koboplus: not applicable
      return 0;
    }

    async function processFiles(files, dateString) {
      setStatus('Processing‚Ä¶', 'ok');
      log(`Starting processing for ${files.length} file(s).`);

      const allRows = [];

      for (const file of files) {
        const platform = detectPlatform(file.name);
        if (!platform) {
          log(`Skipping (unknown platform by filename): ${file.name}`);
          continue;
        }

        log(`Reading ${file.name} as platform: ${platformLabel(platform)}`);

        let rawRows = [];
        if (file.name.toLowerCase().endsWith('.xlsx')) rawRows = await parseXLSXFile(file);
        else rawRows = await parseCSVFile(file);

        log(`  Parsed ${rawRows.length} row(s) from ${file.name}`);

        for (const raw of rawRows) {
          const row = normalizeKeys(raw);

          const royalty = toNumber(row['royalty']);
          const title = safeString(row['title'], '(Missing title)');
          const publisher = safeString(row['publisher'], 'Unknown_Publisher');

          const copies = deriveCopies(platform, row);

          allRows.push({ title, publisher, royalty, copies, platform });
        }
      }

      if (allRows.length === 0) {
        throw new Error('No usable rows found. Check filenames and required columns (title/publisher/royalty).');
      }

      log(`Combined dataset: ${allRows.length} row(s).`);

      const byPublisher = new Map();
      for (const r of allRows) {
        const pub = safeString(r.publisher, 'Unknown_Publisher');
        if (!byPublisher.has(pub)) byPublisher.set(pub, []);
        byPublisher.get(pub).push(r);
      }

      const expectedColumns = ['Title', 'Sold_Copies', ...PLATFORMS.map(platformLabel), 'Total'];
      const outputs = [];

      for (const [publisher, rows] of byPublisher.entries()) {
        log(`Building report for publisher: ${publisher}`);

        const byTitle = new Map();
        for (const r of rows) {
          const t = safeString(r.title, '(Missing title)');
          if (!byTitle.has(t)) byTitle.set(t, []);
          byTitle.get(t).push(r);
        }

        const table = [];
        for (const [title, tRows] of byTitle.entries()) {
          const soldCopies = Math.round(tRows.reduce((acc, x) => acc + (x.copies || 0), 0));

          const rowOut = { Title: title, Sold_Copies: soldCopies };
          let totalRoyalty = 0;

          for (const p of PLATFORMS) {
            const sumP = tRows
              .filter(x => x.platform === p)
              .reduce((acc, x) => acc + (x.royalty || 0), 0);
            rowOut[platformLabel(p)] = Math.round(sumP * 100) / 100;
            totalRoyalty += sumP;
          }
          rowOut['Total'] = Math.round(totalRoyalty * 100) / 100;
          table.push(rowOut);
        }

        const totalRow = { Title: 'Total' };
        for (const col of expectedColumns.slice(1)) totalRow[col] = 0;

        for (const r of table) {
          totalRow['Sold_Copies'] += toNumber(r['Sold_Copies']);
          for (const p of PLATFORMS) totalRow[platformLabel(p)] += toNumber(r[platformLabel(p)]);
          totalRow['Total'] += toNumber(r['Total']);
        }

        totalRow['Sold_Copies'] = Math.round(totalRow['Sold_Copies']);
        for (const p of PLATFORMS) totalRow[platformLabel(p)] = Math.round(totalRow[platformLabel(p)] * 100) / 100;
        totalRow['Total'] = Math.round(totalRow['Total'] * 100) / 100;

        const totalRoyaltyValue = toNumber(totalRow['Total']);
        const distributionFee = Math.round(totalRoyaltyValue * 0.10 * 100) / 100;
        const withdrawalFee = 5.00;
        const payable = Math.round((totalRoyaltyValue - distributionFee - withdrawalFee) * 100) / 100;

        const reportTitle = `${publisher}ÔºàÁôºË°åÊúçÂãôÂ†±Ë°® ${dateString}Ôºâ`;

        const csvRows = [];
        csvRows.push([reportTitle]);
        csvRows.push(expectedColumns);

        for (const r of table) csvRows.push(expectedColumns.map(c => r[c] ?? ''));
        csvRows.push(expectedColumns.map(c => totalRow[c] ?? ''));
        csvRows.push([]);
        csvRows.push(['Payable = Total royalty - 10% distribution fee - 5 USD withdrawal administration fee']);
        csvRows.push([`Total Payable: ${payable.toFixed(2)} USD`]);

        const csvContent = '\ufeff' + csvStringify(csvRows);

        const safePublisher = publisher.replace(/\s+/g, '_');
        const outName = `${safePublisher}_${dateString}_report.csv`;
        outputs.push({ filename: outName, content: csvContent });

        log(`  ‚úì Created ${outName} (${table.length} title(s))`);
      }

      // Build platform revenue summary
      const summaryMap = {};
      for (const p of PLATFORMS) summaryMap[p] = 0;
      for (const r of allRows) {
        if (summaryMap[r.platform] !== undefined) summaryMap[r.platform] += (r.royalty || 0);
      }
      const summaryRows = PLATFORMS.map(p => ({
        Platform: platformLabel(p),
        Revenue: Math.round(summaryMap[p] * 100) / 100
      }));
      const grandTotal = summaryRows.reduce((s, r) => s + r.Revenue, 0);
      summaryRows.push({ Platform: 'Total', Revenue: Math.round(grandTotal * 100) / 100 });

      const summaryWs = XLSX.utils.json_to_sheet(summaryRows);
      const summaryWb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(summaryWb, summaryWs, 'Platform Summary');
      const summaryArrayBuf = XLSX.write(summaryWb, { bookType: 'xlsx', type: 'array' });
      const summaryBlob = new Blob([summaryArrayBuf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

      log(`Creating ZIP with ${outputs.length} report(s)‚Ä¶`);
      const zip = new JSZip();
      for (const o of outputs) zip.file(o.filename, o.content);
      const blob = await zip.generateAsync({ type: 'blob' });
      log('ZIP ready.');

      return { blob, summaryBlob, outputsCount: outputs.length };
    }

    processBtn.addEventListener('click', async () => {
      resetDownload();
      logEl.textContent = '';

      const files = [...(fileInput.files || [])];
      const dateString = (dateStringEl.value || '').trim() || 'date_range';
      if (!files.length) return;

      processBtn.disabled = true;
      downloadBtn.disabled = true;
      downloadSummaryBtn.disabled = true;

      try {
        const { blob, summaryBlob, outputsCount } = await processFiles(files, dateString);
        lastZipBlobUrl = URL.createObjectURL(blob);
        lastSummaryBlobUrl = URL.createObjectURL(summaryBlob);
        downloadBtn.disabled = false;
        downloadSummaryBtn.disabled = false;
        setStatus(`Done: ${outputsCount} report(s)`, 'ok');
        log('‚úÖ Done. Click "Download ZIP" or "Download Summary XLSX".');
      } catch (err) {
        console.error(err);
        setStatus('Error', 'bad');
        log(`‚ùå Error: ${err.message || err}`);
      } finally {
        processBtn.disabled = false;
      }
    });

    downloadBtn.addEventListener('click', () => {
      if (!lastZipBlobUrl) return;
      const dateString = (dateStringEl.value || '').trim() || 'date_range';

      const a = document.createElement('a');
      a.href = lastZipBlobUrl;
      a.download = `publisher_reports_${dateString}.zip`;
      document.body.appendChild(a);
      a.click();
      a.remove();

      log('‚¨áÔ∏è Download started.');
    });

    downloadSummaryBtn.addEventListener('click', () => {
      if (!lastSummaryBlobUrl) return;
      const dateString = (dateStringEl.value || '').trim() || 'date_range';

      const a = document.createElement('a');
      a.href = lastSummaryBlobUrl;
      a.download = `platform_summary_${dateString}.xlsx`;
      document.body.appendChild(a);
      a.click();
      a.remove();

      log('‚¨áÔ∏è Summary XLSX download started.');
    });

    setStatus('Idle');
  </script>
</body>
</html>
