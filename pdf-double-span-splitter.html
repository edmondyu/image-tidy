<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDF Double-Span Splitter</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 800px;
      margin: 40px auto;
    }
    input, button {
      margin: 10px 0;
    }
    canvas {
      border: 1px solid #ccc;
      max-width: 100%;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<h1>PDF Double-Span â†’ Single Pages</h1>

<input type="file" id="pdfInput" accept="application/pdf" />
<br>

<label>
  Split position:
  <input type="range" id="splitRatio" min="40" max="60" value="50" />
  <span id="ratioLabel">50%</span>
</label>
<br>

<label>
  <input type="checkbox" id="rtlOrder" />
  Right-to-left order
</label>
<br>

<button id="splitBtn" disabled>Split & Download PDF</button>

<canvas id="preview"></canvas>

<script type="module">
  import * as pdfjsLib from "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.min.mjs";
  import { PDFDocument } from "https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/+esm";

  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.worker.min.mjs";

  const pdfInput = document.getElementById("pdfInput");
  const splitBtn = document.getElementById("splitBtn");
  const splitRatioInput = document.getElementById("splitRatio");
  const ratioLabel = document.getElementById("ratioLabel");
  const rtlOrderCheckbox = document.getElementById("rtlOrder");
  const previewCanvas = document.getElementById("preview");
  const previewCtx = previewCanvas.getContext("2d");

  let loadedPdf = null;

  splitRatioInput.addEventListener("input", () => {
    ratioLabel.textContent = splitRatioInput.value + "%";
    if (loadedPdf) renderPreview();
  });

  pdfInput.addEventListener("change", async () => {
    const file = pdfInput.files[0];
    if (!file) return;

    const arrayBuffer = await file.arrayBuffer();
    loadedPdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

    await renderPreview();
    splitBtn.disabled = false;
  });

  async function renderPreview() {
    const page = await loadedPdf.getPage(1);
    const viewport = page.getViewport({ scale: 1.5 });

    previewCanvas.width = viewport.width;
    previewCanvas.height = viewport.height;

    await page.render({
      canvasContext: previewCtx,
      viewport
    }).promise;

    const splitX = viewport.width * (splitRatioInput.value / 100);

    previewCtx.strokeStyle = "red";
    previewCtx.lineWidth = 2;
    previewCtx.beginPath();
    previewCtx.moveTo(splitX, 0);
    previewCtx.lineTo(splitX, viewport.height);
    previewCtx.stroke();
  }

  splitBtn.addEventListener("click", async () => {
    const outputPdf = await PDFDocument.create();
    const splitRatio = splitRatioInput.value / 100;
    const rtl = rtlOrderCheckbox.checked;

    for (let i = 1; i <= loadedPdf.numPages; i++) {
      const page = await loadedPdf.getPage(i);
      const viewport = page.getViewport({ scale: 2 });

      const srcCanvas = document.createElement("canvas");
      const srcCtx = srcCanvas.getContext("2d");
      srcCanvas.width = viewport.width;
      srcCanvas.height = viewport.height;

      await page.render({
        canvasContext: srcCtx,
        viewport
      }).promise;

      const splitX = Math.floor(srcCanvas.width * splitRatio);

      const halves = [
        { x: 0, w: splitX },
        { x: splitX, w: srcCanvas.width - splitX }
      ];

      if (rtl) halves.reverse();

      for (const half of halves) {
        const c = document.createElement("canvas");
        c.width = half.w;
        c.height = srcCanvas.height;

        const ctx = c.getContext("2d");
        ctx.drawImage(
          srcCanvas,
          half.x, 0, half.w, srcCanvas.height,
          0, 0, half.w, srcCanvas.height
        );

        const imgBytes = await new Promise(res => c.toBlob(b => {
          b.arrayBuffer().then(res);
        }, "image/jpeg", 0.95));

        const img = await outputPdf.embedJpg(imgBytes);
        const pageOut = outputPdf.addPage([c.width, c.height]);
        pageOut.drawImage(img, {
          x: 0,
          y: 0,
          width: c.width,
          height: c.height
        });
      }
    }

    const pdfBytes = await outputPdf.save();
    const blob = new Blob([pdfBytes], { type: "application/pdf" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "split.pdf";
    a.click();

    URL.revokeObjectURL(url);
  });
</script>

</body>
</html>
