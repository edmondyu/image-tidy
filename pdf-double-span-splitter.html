<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDF Double-Span Splitter</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 1.5rem;
      background: #131313;
      color: #f9f9f9;
    }
    h1 {
      color: #50e3c2;
      margin-bottom: 1rem;
    }
    input, button {
      margin: 10px 0;
    }
    input[type="file"] {
      color: #f9f9f9;
    }
    input[type="range"] {
      margin: 0 10px;
    }
    input[type="checkbox"] {
      margin-right: 8px;
    }
    label {
      color: #50e3c2;
      font-size: 0.9rem;
      display: inline-block;
      margin-bottom: 0.5rem;
    }
    button {
      cursor: pointer;
      border: none;
      border-radius: 6px;
      padding: 0.6rem 1.1rem;
      font-size: 0.95rem;
      background: #50e3c2;
      color: #131313;
      margin-right: 0.5rem;
    }
    button:hover:not(:disabled) {
      background: #3dd4b3;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    canvas {
      border: 1px solid #2a2a2a;
      max-width: 100%;
      margin-top: 10px;
      background: #1f1f1f;
    }
    .drop-zone {
      position: relative;
      border: 2px dashed #3a3a3a;
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      transition: all 0.3s;
      background: #2a2a2a;
      margin-bottom: 1rem;
    }
    .drop-zone.drag-over {
      border-color: #50e3c2;
      background: #1a3a35;
    }
    .drop-zone p {
      margin: 0.5rem 0;
      color: #9ca3af;
    }
    .drop-zone .drop-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      color: #50e3c2;
    }
    .drop-zone input[type="file"] {
      display: none;
    }
    .drop-zone .file-input-wrapper {
      margin-top: 1rem;
    }
    .drop-zone .browse-btn {
      background: #3a3a3a;
      color: #f9f9f9;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      display: inline-block;
      font-size: 0.9rem;
    }
    .drop-zone .browse-btn:hover {
      background: #4a4a4a;
    }
    .drop-zone.has-file {
      border-color: #10b981;
      background: #064e3b;
    }
    .drop-zone.has-file .drop-icon {
      color: #10b981;
    }
  </style>
</head>
<body>

<h1>PDF Double-Span â†’ Single Pages</h1>

<div class="drop-zone" id="pdfDropZone">
  <div class="drop-icon">ðŸ“•</div>
  <p><strong>Drag and drop PDF file here</strong></p>
  <p>or</p>
  <div class="file-input-wrapper">
    <label for="pdfInput" class="browse-btn">Browse Files</label>
    <input type="file" id="pdfInput" accept="application/pdf" />
  </div>
</div>

<label>
  Split position:
  <input type="range" id="splitRatio" min="40" max="60" value="50" />
  <span id="ratioLabel">50%</span>
</label>
<br>

<label>
  <input type="checkbox" id="rtlOrder" />
  Right-to-left order
</label>
<br>

<button id="splitBtn" disabled>Split & Download PDF</button>

<canvas id="preview"></canvas>

<script type="module">
  import * as pdfjsLib from "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.min.mjs";
  import { PDFDocument } from "https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/+esm";

  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.worker.min.mjs";

  const pdfInput = document.getElementById("pdfInput");
  const pdfDropZone = document.getElementById("pdfDropZone");
  const splitBtn = document.getElementById("splitBtn");
  const splitRatioInput = document.getElementById("splitRatio");
  const ratioLabel = document.getElementById("ratioLabel");
  const rtlOrderCheckbox = document.getElementById("rtlOrder");
  const previewCanvas = document.getElementById("preview");
  const previewCtx = previewCanvas.getContext("2d");

  let loadedPdf = null;

  // Drag and drop helper functions
  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  function highlight(dropZone) {
    dropZone.classList.add('drag-over');
  }

  function unhighlight(dropZone) {
    dropZone.classList.remove('drag-over');
  }

  function setupDropZone(dropZone, onDrop) {
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, preventDefaults, false);
    });

    dropZone.addEventListener('dragenter', () => highlight(dropZone), false);
    dropZone.addEventListener('dragover', () => highlight(dropZone), false);
    dropZone.addEventListener('dragleave', (e) => {
      if (e.target === dropZone) {
        unhighlight(dropZone);
      }
    }, false);
    dropZone.addEventListener('drop', (e) => {
      unhighlight(dropZone);
      onDrop(e);
    }, false);
  }

  splitRatioInput.addEventListener("input", () => {
    ratioLabel.textContent = splitRatioInput.value + "%";
    if (loadedPdf) renderPreview();
  });

  async function handleFileSelection(file) {
    if (!file) return;

    const arrayBuffer = await file.arrayBuffer();
    loadedPdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

    await renderPreview();
    splitBtn.disabled = false;
    pdfDropZone.classList.add('has-file');
  }

  pdfInput.addEventListener("change", async () => {
    const file = pdfInput.files[0];
    await handleFileSelection(file);
  });

  setupDropZone(pdfDropZone, async (e) => {
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      const file = files[0];
      if (file.name.endsWith('.pdf') || file.type === 'application/pdf') {
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        pdfInput.files = dataTransfer.files;
        await handleFileSelection(file);
      }
    }
  });

  async function renderPreview() {
    const page = await loadedPdf.getPage(1);
    const viewport = page.getViewport({ scale: 1.5 });

    previewCanvas.width = viewport.width;
    previewCanvas.height = viewport.height;

    await page.render({
      canvasContext: previewCtx,
      viewport
    }).promise;

    const splitX = viewport.width * (splitRatioInput.value / 100);

    previewCtx.strokeStyle = "red";
    previewCtx.lineWidth = 2;
    previewCtx.beginPath();
    previewCtx.moveTo(splitX, 0);
    previewCtx.lineTo(splitX, viewport.height);
    previewCtx.stroke();
  }

  splitBtn.addEventListener("click", async () => {
    const outputPdf = await PDFDocument.create();
    const splitRatio = splitRatioInput.value / 100;
    const rtl = rtlOrderCheckbox.checked;

    for (let i = 1; i <= loadedPdf.numPages; i++) {
      const page = await loadedPdf.getPage(i);
      const viewport = page.getViewport({ scale: 2 });

      const srcCanvas = document.createElement("canvas");
      const srcCtx = srcCanvas.getContext("2d");
      srcCanvas.width = viewport.width;
      srcCanvas.height = viewport.height;

      await page.render({
        canvasContext: srcCtx,
        viewport
      }).promise;

      const splitX = Math.floor(srcCanvas.width * splitRatio);

      const halves = [
        { x: 0, w: splitX },
        { x: splitX, w: srcCanvas.width - splitX }
      ];

      if (rtl) halves.reverse();

      for (const half of halves) {
        const c = document.createElement("canvas");
        c.width = half.w;
        c.height = srcCanvas.height;

        const ctx = c.getContext("2d");
        ctx.drawImage(
          srcCanvas,
          half.x, 0, half.w, srcCanvas.height,
          0, 0, half.w, srcCanvas.height
        );

        const imgBytes = await new Promise(res => c.toBlob(b => {
          b.arrayBuffer().then(res);
        }, "image/jpeg", 0.95));

        const img = await outputPdf.embedJpg(imgBytes);
        const pageOut = outputPdf.addPage([c.width, c.height]);
        pageOut.drawImage(img, {
          x: 0,
          y: 0,
          width: c.width,
          height: c.height
        });
      }
    }

    const pdfBytes = await outputPdf.save();
    const blob = new Blob([pdfBytes], { type: "application/pdf" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "split.pdf";
    a.click();

    URL.revokeObjectURL(url);
  });
</script>

</body>
</html>
